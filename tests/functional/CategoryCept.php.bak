<?php



		$I = new TestGuy($scenario);
		$I->wantTo('test Category API page is working');

//		$I->amOnPage('/login');
//		$I->canSee('Sign In');
///*		

		$I->sendPOST('/category/getmegamenu',
			array('data'=>
				'{"clientId": "90794e3b050f815354e3e29e977a88ab",
				"clientToken": "123"}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());
		$I->assertGreaterThan(10,count($json->megamenu));

		// CREATE 1 minimalist
		$staticAreaIds = [13,14,15,16,18];
		shuffle($staticAreaIds);
		
		$req = array('data'=>
				'{"clientId": "90794e3b050f815354e3e29e977a88ab",
				"clientToken": "123",
				"parentId" : "9",
				"name" : "Pants Cheap",
				"description" : "sample description pants cheap",
				"displayMode" : "1",
				"pageLayout" : "1",
				"includeInMenu" : "1",
				"staticAreaId": "'.$staticAreaIds[0].'",
				"level" : "2",
				"position" : "1",
				"isActive" : "1",
				"key":"test'.rand(1000,9999).'.html" }');
		$I->sendPOST('/category/set',$req);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());
		//die(var_export($json,1));
		
		// TODO : UPDATE
		shuffle($staticAreaIds);
		$req = array('data'=>
				'{"clientId": "90794e3b050f815354e3e29e977a88ab",
				"clientToken": "123",
				"id": "'.$json->id.'",
				"parentId" : "9",
				"name" : "Pants Cheap1",
				"description" : "sample description pants cheap1",
				"displayMode" : "1",
				"pageLayout" : "1",
				"includeInMenu" : "1",
				"staticAreaId": "'.$staticAreaIds[0].'",
				"level" : "2",
				"position" : "1",
				"isActive" : "1",
				"key":"test'.rand(1000,9999).'.html" }');
		$I->sendPOST('/category/set',$req);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());
		
		
		
		//GETS
		$res = (array)json_decode($req['data']);
		unset($res['clientId'],$res['clientToken']);
		foreach($res as $k=>$r){
			$I->sendPOST('/category/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "'.$k.'", "filter" : "=", "value" : "'.$r.'"}], "sortBy" : [ {"field" : "'.$k.'"}], "limit" : "'.rand(1,100).'"}'));
			$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
			$I->seeResponseIsJson();
			//$res = (array)json_decode($req['data']);
			//unset($res['clientId'],$res['clientToken']);
			//foreach($res as $k=>$r)
			//	$I->seeResponseContainsJson(array('brands'=>array(array($k=>(string)$r))));
			
		}
				
		$I->sendPOST('/category/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "id", "filter" : "=", "value" : "'.$json->id.'"}], "limit" : "'.rand(1,100).'"}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		//foreach($res as $k=>$r)
		$I->seeResponseContainsJson(array('categories'=>array(array_intersect_key(array_merge($res,array_intersect_key((array)$json,array_flip(array('parentId','key')))),array_flip(array('id','name','parentId','key','path','isActive','totalProduct','position'))))));

		
		
		
		//Category PRODUCT
		
		$productId = rand(1000,1860);
		//SET
		$req1 = array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "categoryId":"'.$json->id.'", "products":[{"id":"'.$productId.'","sort":"1","productPath":"//"}]}');
		$I->sendPOST('/category/products/set',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$response = $I->grabResponse();
		
		
		//$I->seeRecord('Api\Category\Models\CategoryProducts', ['categoryId'=>$json->id,'productId'=>$productId]);
		//die($response);
		//GET
		$I->sendPOST('/category/products/get',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "categoryId", "filter" : "=", "value" : "'.$json->id.'"}],"sortBy" : [{"field" : "categoryId", "value" : "asc"}], "limit" : "5"}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		
		$model = $I->grabRecord('Api\Product\Models\Products', ['id'=>$productId]);
		
		//REMOVE
		$I->sendPOST('/category/products/remove',array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "categoryId":"'.$json->id.'", "products":["'.$model->sku.'"]}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();

		
		
		
		
		
		
		// REMOVE see record
		$req['data'] = (array)json_decode($req['data']);
		unset($req['data']['clientId'],$req['data']['clientToken']);
		$I->seeRecord('Api\Category\Models\Categories', $req['data']);
		
		// REMOVE
		$req1 = array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "id":"'.$json->id.'"}');
		$I->sendPOST('/category/remove',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();

		// REMOVE don't see record
		$I->dontSeeRecord('Api\Category\Models\Categories', $req['data']);

		return;
		
		
		// CREATE 3 complete
		$req = array('data'=>'{"clientId": "546c626d52e9f", "pageLayout":"3", "displayMode":"1", "clientToken": "1416389229", "name":"static page 1", "status":1, "path":"//", "key":"sp1'.rand(1000,9999).'", "content":"<div>","logo":"abc","description":"apa aja"}');
		$I->sendPOST('/brand/set',$req);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());
		
		// UPDATE
		$req = array('data'=>'{"clientId": "546c626d52e9f", "pageLayout":"3", "id": "'.$json->id.'", "displayMode":"1", "clientToken": "1416389229", "name":"static page 2", "status":"1", "path":"//", "key":"sp1'.rand(1000,9999).'", "content":"<div>","logo":"abc","description":"apa aja"}');
		$I->sendPOST('/brand/set',$req);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());		
		
		// GET
		$req1 = array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "id" : "'.$json->id.'"}');
		$I->sendPOST('/brand/get',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$res = (array)json_decode($req['data']);
		unset($res['clientId'],$res['clientToken']);
		foreach($res as $k=>$r)
			$I->seeResponseContainsJson(array($k=>(string)$r));
			
		$response = $I->grabResponse();
		

		
		
		//GETS
		$res = (array)json_decode($req['data']);
		unset($res['clientId'],$res['clientToken']);
		foreach($res as $k=>$r){
			$I->sendPOST('/brand/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "'.$k.'", "filter" : "=", "value" : "'.$r.'"}], "sortBy" : [ {"field" : "'.$k.'"}], "limit" : "'.rand(1,100).'"}'));
			$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
			$I->seeResponseIsJson();
			//$res = (array)json_decode($req['data']);
			//unset($res['clientId'],$res['clientToken']);
			//foreach($res as $k=>$r)
			//	$I->seeResponseContainsJson(array('brands'=>array(array($k=>(string)$r))));
			
		}
		
		//die(var_export($response,1));
		//die(var_export(array_merge($res,array_intersect_key((array)$response,array_flip(array('createdDate','lastUpdatedDate')))),1));
		
		$I->sendPOST('/brand/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "id", "filter" : "=", "value" : "'.$json->id.'"}], "limit" : "'.rand(1,100).'"}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		//foreach($res as $k=>$r)
		$I->seeResponseContainsJson(array('brands'=>array(array_intersect_key(array_merge($res,array_intersect_key((array)json_decode($response),array_flip(array('createdDate','lastUpdatedDate')))),array_flip(array('name','logo','description','key','path','status','id','createdDate','lastUpdatedDate'))))));
		
		
		//==============BRAND PRODUCT=================//
		
		$productId = rand(1000,1860);
		//SET
		$req1 = array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "brandId":"'.$json->id.'", "products":[{"id":"'.$productId.'","sort":"1","productPath":"//"}]}');
		$I->sendPOST('/brand/product/set',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$response = $I->grabResponse();
		
		
		//GET
		$I->sendPOST('/brand/product/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "brandId", "filter" : "=", "value" : "'.$json->id.'"}],"sortBy" : [{"field" : "brandId", "value" : "asc"}], "limit" : "5"}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		
		
		//REMOVE
		$I->sendPOST('/brand/product/remove',array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "brandId":"'.$json->id.'", "products":["'.$productId.'"]}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();






		// REMOVE see record
		$req['data'] = (array)json_decode($req['data']);
		unset($req['data']['clientId'],$req['data']['clientToken']);
		$I->seeRecord('Api\Brand\Models\Brands', $req['data']);
		
		// REMOVE
		$req1 = array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "brandId":"'.$json->id.'"}');
		$I->sendPOST('/brand/remove',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();

		// REMOVE don't see record
		$I->dontSeeRecord('Api\Brand\Models\Brands', $req['data']);
		
		
		return;