<?php



		$I = new TestGuy($scenario);
		$I->wantTo('test vendor API page is working');

//		$I->amOnPage('/login');
//		$I->canSee('Sign In');
///*		
		//Vendor
		//$id = $I->haveRecord('Api\Vendor\Models\Vendors', ['name'=>'dancow','logo'=>'dancow','description'=>'susu','key'=>'dancow','path'=>'dancow']);
		//$model = $I->grabRecord('Api\Vendor\Models\Vendors', ['name'=>'dancow','logo'=>'dancow','description'=>'susu','key'=>'dancow','path'=>'dancow']);

		// CREATE 1 minimalist
		$I->sendPOST('/vendor/set',
			array('data'=>
				'{"clientId": "546c626d52e9f",
				  "clientToken": "1416389229", 
				  "name":"static page 1", 
				  "status":1, 
				  "path":"//", 
				  "key":"sp1'.rand(1000,9999).'", 
				  "content":"<div>"
				  }'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());
		
		// CREATE 2 test error
		$I->sendPOST('/vendor/set',
			array('data'=>
				'{"clientId": "546c626d52e9f",
				  "clientToken": "1416389229", 
				  "name":123, 
				  "status":1, 
				  "path":"//", 
				  "key":"sp1'.rand(1000,9999).'",
				  "pageLayout":3,
				  "displayMode":9999999999999999, 
				  "content":"<div>"
				  }'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'ORM Failed:: Max displayMode is 32767'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());
		
		// CREATE 3 complete
		$req = array('data'=>'{"clientId": "546c626d52e9f", "pageLayout":"3", "displayMode":"1", "clientToken": "1416389229", "name":"static page 1", "status":1, "path":"//", "key":"sp1'.rand(1000,9999).'", "content":"<div>","logo":"abc","description":"apa aja"}');
		$I->sendPOST('/vendor/set',$req);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());
		
		// UPDATE
		$req = array('data'=>'{"clientId": "546c626d52e9f", "pageLayout":"3", "id": "'.$json->id.'", "displayMode":"1", "clientToken": "1416389229", "name":"static page 2", "status":"1", "path":"//", "key":"sp1'.rand(1000,9999).'", "content":"<div>","logo":"abc","description":"apa aja"}');
		$I->sendPOST('/vendor/set',$req);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$json = json_decode($I->grabResponse());		
		
		// GET
		$req1 = array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "id" : "'.$json->id.'"}');
		$I->sendPOST('/vendor/get',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$res = (array)json_decode($req['data']);
		unset($res['clientId'],$res['clientToken']);
		foreach($res as $k=>$r)
			$I->seeResponseContainsJson(array($k=>(string)$r));
			
		$response = $I->grabResponse();
		

		
		
		//GETS
		$res = (array)json_decode($req['data']);
		unset($res['clientId'],$res['clientToken']);
		foreach($res as $k=>$r){
			$I->sendPOST('/vendor/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "'.$k.'", "filter" : "=", "value" : "'.$r.'"}], "sortBy" : [ {"field" : "'.$k.'"}], "limit" : "'.rand(1,100).'"}'));
			$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
			$I->seeResponseIsJson();
			//$res = (array)json_decode($req['data']);
			//unset($res['clientId'],$res['clientToken']);
			//foreach($res as $k=>$r)
			//	$I->seeResponseContainsJson(array('vendors'=>array(array($k=>(string)$r))));
			
		}
		
		//die(var_export($response,1));
		//die(var_export(array_merge($res,array_intersect_key((array)$response,array_flip(array('createdDate','lastUpdatedDate')))),1));
		
		$I->sendPOST('/vendor/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "id", "filter" : "=", "value" : "'.$json->id.'"}], "limit" : "'.rand(1,100).'"}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		//foreach($res as $k=>$r)
		$I->seeResponseContainsJson(array('vendors'=>array(array_intersect_key(array_merge($res,array_intersect_key((array)json_decode($response),array_flip(array('createdDate','lastUpdatedDate')))),array_flip(array('name','logo','description','key','path','status','id','createdDate','lastUpdatedDate'))))));
		
		
		//==============BRAND PRODUCT=================//
		
		$productId = rand(1000,1860);
		//SET
		$req1 = array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "vendorId":"'.$json->id.'", "products":[{"id":"'.$productId.'","sort":"1","productPath":"//"}]}');
		$I->sendPOST('/vendor/product/set',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		$response = $I->grabResponse();
		
		
		//GET
		$I->sendPOST('/vendor/product/gets',array('data'=>'{"clientId": "90794e3b050f815354e3e29e977a88ab", "clientToken": "123", "conditions" : [ {"field" : "vendorId", "filter" : "=", "value" : "'.$json->id.'"}],"sortBy" : [{"field" : "vendorId", "value" : "asc"}], "limit" : "5"}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();
		
		
		//REMOVE
		$I->sendPOST('/vendor/product/remove',array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "vendorId":"'.$json->id.'", "products":["'.$productId.'"]}'));
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();






		// REMOVE see record
		$req['data'] = (array)json_decode($req['data']);
		unset($req['data']['clientId'],$req['data']['clientToken']);
		$I->seeRecord('Api\Vendor\Models\Vendors', $req['data']);
		
		// REMOVE
		$req1 = array('data'=>'{"clientId": "546c626d52e9f",  "clientToken": "1416389229", "vendorId":"'.$json->id.'"}');
		$I->sendPOST('/vendor/remove',$req1);
		$I->seeResponseContainsJson(array('responseCodeDescription' => 'OK'));
		$I->seeResponseIsJson();

		// REMOVE don't see record
		$I->dontSeeRecord('Api\Vendor\Models\Vendors', $req['data']);
		
		
		return;