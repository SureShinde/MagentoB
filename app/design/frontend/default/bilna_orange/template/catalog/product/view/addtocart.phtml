<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php $_escape_helper = Mage::helper('catalog/utils'); ?>
<?php $_product = $this->getProduct(); ?>

<?php $buttonTitle = $this->__('Tambah ke troli'); ?>
<?php $_cart = Mage::getModel('checkout/cart')->getQuote(); ?>
<?php $_items = $_cart->getAllItems(); ?>
<?php $itemQty = 0; ?>
<?php foreach ($_items as $_item) { if(empty($_item->getParentItemId())) {$itemQty++;} }?>
<?php if($_product->isSaleable()): ?>
    <div class="add-to-cart">
        <?php if(!$_product->isGrouped()): ?>
        <label for="qty"><?php echo $this->__('Jumlah:') ?></label>
        <input type="text" name="qty" id="qty" maxlength="12" value="<?php echo $this->getProductDefaultQty() * 1 ?>" title="<?php echo $this->__('Jumlah') ?>" class="input-text qty" />
        <?php endif; ?>
        <button type="button" title="<?php echo $buttonTitle ?>" class="button btn-cart" onclick="productAddToCartForm.submit(this); ecommerceProductDetailAddToCart('<?php echo $_escape_helper->escapeQuote($_product->getName()); ?>','<?php echo $_product->getSku() ?>','<?php echo $_product->getPrice() ?>','<?php echo $_product->getProductUrl() ?>','<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(135); ?>');"><i class="fa fa-cart-plus"></i><span><?php echo $buttonTitle ?></span></button>
        <?php echo $this->getChildHtml('', true, true) ?>
        <a class="coll-quick addToCollectionLink coll-quick-top" onclick="showAddToCollectionDialog()" href="javascript:;"
                data-brand-name="<?php echo $brand; ?>"
                data-image="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(320, 320); ?>"
                data-product-name="<?php echo $this->stripTags($_product->getName(), null, true); ?>"
                data-price="<?php echo 'Rp. ' . number_format($_product->getPrice(), 0, '', '.'); ?>"
                data-merchant = "<?php echo ($merchant) ? 'dijual oleh ' . $merchant : ''; ?>"
                data-id="<?php echo $_product->getId(); ?>"
                ><i class="fa fa-heart"></i></a>
    </div>
<?php endif; ?>

<script type="text/javascript">
function ecommerceProductDetailAddToCart(name, sku, price, link, imageUrl) {
    if (jQuery("div.input-box select").val() != false) {
      dataLayer.push({
        'event': 'addToCart',
        'ecommerce': {
          'currencyCode': 'IDR',
          'add': {                                // 'add' actionFieldObject measures.
            'actionField': {'list': 'browsing'},
            'products': [{                        //  adding a product to a shopping cart.
              'name': name,
              'id': sku,
              'price': price,
              'quantity': jQuery("input.#qty").val(),
              'brandName': 'brand name',
              'imageUrl': imageUrl,
              'link': link
             }]
          }
        }
      });

      // ematics cart - retrieve items from cart
      var temp_cart = [];
      var temp_item = "";
      var index_addeditem = -999;

      for (var itr=0; itr < <?php echo $itemQty ?>; itr++) {
        temp_item = jQuery(".mini-cart span#ematiccart").eq(itr).text();
        temp_cart[itr] = temp_item.split("|");
        if (temp_item.indexOf(sku) > -1) {
          index_addeditem = itr;
        }
      }

      // ematics cart - prepare for logging
      products = [
      <?php for($i=0; $i<$itemQty; $i++) {
        echo "{'name' : temp_cart[".$i."][0],";
        echo "'id' : temp_cart[".$i."][1],";
        echo "'price' : temp_cart[".$i."][2],";
        echo "'quantity' : temp_cart[".$i."][3],";
        echo "'brandName' : 'brand name',";
        echo "'imageUrl' : temp_cart[".$i."][4],";
        echo "'link' : temp_cart[".$i."][5]}";if($i != $itemQty-1) {echo ",";}
      } 
      ?>
      ];

      // ematics added item
      if (index_addeditem != -999) {    // same item exist in cart
        products[index_addeditem].quantity = parseInt(products[index_addeditem].quantity) + parseInt(jQuery("input.#qty").val());
      }
      else {    // no same item
        products.push({
          'id': sku,
          'price': price,
          'quantity': jQuery("input.#qty").val(),
          'name': name,
          'brandName': 'brand name',
          'imageUrl': imageUrl,
          'link': link
        });
      }
      
      // ematics track items in cart to enable pre-abandonded cart overlays
      ematics("log", "product", "cart", products);
    } 
}
</script>